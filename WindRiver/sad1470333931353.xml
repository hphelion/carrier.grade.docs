<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task-wr PUBLIC "-//WindRiver.com//DTD DITA 1.2 Wind River General Task//EN" "task-wr.dtd">
<task-wr id="sad1470333931353" xml:lang="en-us">
<!-- Modification History
        
-->
    <title ixia_locid="391">Installing Reboot-Required Patches Using the CLI</title>
    <shortdesc ixia_locid="392">You can install reboot-required patches using the CLI. </shortdesc>
    <prolog>
        <author ixia_locid="393">Edward Knowlton</author>
    </prolog>
    <taskbody>
        <steps id="steps_v1q_vlv_vw">
            <step id="step_N10111_N1010E_N1002B_N10001" ixia_locid="18">
                <cmd ixia_locid="19">Log in as Keystone user <nameliteral ixia_locid="320">admin</nameliteral> to the active controller.</cmd>
                <info ixia_locid="321">
                    <p ixia_locid="61">Log in as user <nameliteral ixia_locid="23">wrsroot</nameliteral> to the active controller and source the script
                            <filepath ixia_locid="322">/etc/nova/openrc</filepath> to obtain
                        administrative privileges as described in <xref href="ekn1460051057968.xml" ixia_locid="405"/>.</p>
                </info>
            </step>
            <step id="step_N1002A_N10027_N1001B_N10001" ixia_locid="6">
                <cmd ixia_locid="7">Verify that the patches are available using the <cmdname ixia_locid="31">sw-patch query</cmdname> command.</cmd>
                <stepxmp ixia_locid="32">
                    <codeblock ixia_locid="255"><systemoutput ixia_locid="257">~(keystone_admin)$ </systemoutput><userinput ixia_locid="259">sudo sw-patch query</userinput>
<systemoutput ixia_locid="261">﻿       Patch ID             Patch State
=========================   ===========
TITANIUM_15.12_PATCH_0001   Available
TITANIUM_15.12_PATCH_0002   Available
TITANIUM_15.12_PATCH_0003   Available</systemoutput></codeblock>
                </stepxmp>
            </step>
            <step id="step_N100AD_N10081_N1001F_N10001" ixia_locid="37">
                <cmd ixia_locid="38">Apply the patch.</cmd>
                <stepxmp ixia_locid="42">
                    <codeblock ixia_locid="43"><systemoutput ixia_locid="286">~(keystone_admin)$ </systemoutput><userinput ixia_locid="45">sudo sw-patch apply TITANIUM_15.12_PATCH_0001</userinput>
<systemoutput ixia_locid="213">TITANIUM_15.12_PATCH_0001 is now in the repo</systemoutput></codeblock>
                </stepxmp>
                <stepresult ixia_locid="47">
                    <p ixia_locid="48">The patch is now in the <i ixia_locid="49">Partial-Apply</i>
                        state, ready for installation from the software updates repository on the
                        impacted hosts.</p>
                </stepresult>
            </step>
            <step id="step_N100FB_N1009F_N1001F_N10001" importance="optional" ixia_locid="50">
                <cmd ixia_locid="51">Apply all available patches in a single operation.</cmd>
                <stepxmp ixia_locid="52">
                    <codeblock ixia_locid="363"><systemoutput ixia_locid="288">~(keystone_admin)$ </systemoutput><userinput ixia_locid="364">sudo sw-patch apply --all</userinput>
<systemoutput ixia_locid="215">TITANIUM_15.12_PATCH_0001 is now in the repo</systemoutput>
<systemoutput ixia_locid="290">TITANIUM_15.12_PATCH_0002 is now in the repo</systemoutput>
<systemoutput ixia_locid="217">TITANIUM_15.12_PATCH_0003 is now in the repo</systemoutput></codeblock>
                </stepxmp>
                <info ixia_locid="59">
                    <p ixia_locid="324">In this example, there are three patches ready for
                        installation from the software updates repository.</p>
                </info>
            </step>
            <step id="step_N1012A_N1009F_N1001F_N10001" ixia_locid="325">
                <cmd ixia_locid="326">Query the patching status of all hosts in the cluster.</cmd>
                <info ixia_locid="64">
                    <p ixia_locid="65">You can query the patching status of all hosts at any time as
                        illustrated below. Note that the reported status is the accumulated result
                        of all applied and removed patches in the software updates repository, and
                        not just the status due to a particular patch.</p>
                </info>
                <stepxmp ixia_locid="66">
                    <codeblock ixia_locid="277"><systemoutput ixia_locid="279">~(keystone_admin)$ </systemoutput><userinput ixia_locid="282">sudo sw-patch query-hosts</userinput>
<systemoutput ixia_locid="284">
  Hostname      IP Address    Patch Current  Reboot Required  Release  State
============  ==============  =============  ===============  =======  =====
compute-0     192.168.204.12       Yes             No          15.12   idle
controller-0  192.168.204.3        No              Yes         15.12   idle
controller-1  192.168.204.4        No              Yes         15.12   idle
</systemoutput></codeblock>
                </stepxmp>
                <stepresult ixia_locid="71">
                    <p ixia_locid="72">For each host in the cluster, the following patch status
                        fields are displayed:</p>
                    <dl>
                        <dlentry ixia_locid="73">
                            <dt ixia_locid="74">Patch Current</dt>
                            <dd ixia_locid="75">
                                <p ixia_locid="76">Indicates whether there are patches pending for
                                    installation or removal on the host or not. If <i ixia_locid="406">Yes</i>, then
                                    all relevant patches in the software updates repository have
                                    been installed on, or removed from, the host already. If <i ixia_locid="78">No</i>, then there is at least one patch in
                                    either the <i ixia_locid="79">Partial-Apply</i> or <i ixia_locid="80">Partial-Remove</i> state that has not been
                                    applied to the host.</p>
                            </dd>
                        </dlentry>
                        <dlentry ixia_locid="81">
                            <dt ixia_locid="82">Reboot Required </dt>
                            <dd ixia_locid="83">
                                <p ixia_locid="84">Indicates whether the host must be rebooted or
                                    not as a result of one or more patches that have been either
                                    applied or removed, or because it is not patch current.</p>
                            </dd>
                        </dlentry>
                        <dlentry ixia_locid="328">
                            <dt ixia_locid="329">Release</dt>
                            <dd ixia_locid="330">
                                <p ixia_locid="331">Indicates the running software release
                                    version.</p>
                            </dd>
                        </dlentry>
                        <dlentry ixia_locid="332">
                            <dt ixia_locid="333">State</dt>
                            <dd ixia_locid="334">
                                <p ixia_locid="335">There are four possible states:</p>
                                <ul id="ul_rqq_yqh_r5">
                                    <li ixia_locid="336">
                                        <p ixia_locid="337">idle - In a wait state.</p>
                                    </li>
                                    <li ixia_locid="338">
                                        <p ixia_locid="339">installing - Installing (or removing)
                                            patches.</p>
                                    </li>
                                    <li ixia_locid="340">
                                        <p ixia_locid="341"><draft-comment author="jowens" ixia_locid="390">U77159 / US83068 mention log server
                                                here?</draft-comment>install-failed - The operation
                                            failed, either due to a patch error or something killed
                                            the process. Check the <filepath ixia_locid="342">patching.log</filepath> on the node in
                                            question.</p>
                                    </li>
                                    <li ixia_locid="343">
                                        <p ixia_locid="344">install-rejected - The node is unlocked,
                                            therefore the request to install has been rejected. This
                                            state persists until there is another install request,
                                            or the node is reset.</p>
                                    </li>
                                </ul>
                                <p ixia_locid="346">Once the state has gone back to idle, the
                                    install operation is complete and you can safely unlock the
                                    node.</p>
                            </dd>
                        </dlentry>
                    </dl>
                    <p ixia_locid="85">In this example, <nameliteral ixia_locid="86">compute-0</nameliteral> is up to date, no patches need to be installed
                        and no reboot is required. By contrast, the controllers are not patch
                        current, and therefore a reboot is required to install the patch.</p>
                </stepresult>
            </step>
            <step id="step_N10190_N1009F_N1001F_N10001" ixia_locid="157">
                <cmd ixia_locid="159">Install all pending patches on <nameliteral ixia_locid="161">controller-0</nameliteral>.</cmd>
                <substeps id="substeps_kzv_x13_pp">
                    <substep ixia_locid="163">
                        <cmd ixia_locid="165">Switch the active controller services.</cmd>
                        <stepxmp ixia_locid="167">
                            <codeblock ixia_locid="169"><systemoutput ixia_locid="292">~(keystone_admin)$ </systemoutput><userinput ixia_locid="173">system host-swact controller-0</userinput></codeblock>
                        </stepxmp>
                        <info ixia_locid="175">
                            <p ixia_locid="177">Before patching a controller node, you must transfer
                                any active services running on the host to the other controller.
                                Only then it is safe to lock the host.</p>
                        </info>
                    </substep>
                    <substep ixia_locid="347">
                        <cmd ixia_locid="348">Lock the host.</cmd>
                        <stepxmp ixia_locid="349">
                            <p ixia_locid="350">You must lock the target host, controller, compute,
                                or storage, before installing patches.</p>
                            <codeblock ixia_locid="351"><systemoutput ixia_locid="368">~(keystone_admin)$</systemoutput> <userinput ixia_locid="353">system host-lock controller-0</userinput></codeblock>
                        </stepxmp>
                    </substep>
                    <substep ixia_locid="354">
                        <cmd ixia_locid="355">Install the patch. </cmd>
                        <stepxmp ixia_locid="369">
                            <codeblock ixia_locid="370"><systemoutput ixia_locid="371">~(keystone_admin)$</systemoutput> <userinput ixia_locid="372">sudo sw-patch host-install <varname ixia_locid="388">controller-0</varname></userinput></codeblock>
                            <note id="note_N10311_N10303_N102FA_N102B0_N102A1_N1010B_N10032_N10001" ixia_locid="373">
                                <p ixia_locid="374">You can use the <cmdname ixia_locid="375">sudo
                                        sw-patch host-install-async</cmdname>
                                    <varname ixia_locid="389">hostname</varname> command if you are
                                    launching multiple installs in parallel. </p>
                            </note>
                        </stepxmp>
                    </substep>
                    <substep ixia_locid="356">
                        <cmd ixia_locid="357">Unlock the host. </cmd>
                        <stepxmp ixia_locid="358">
                            <codeblock ixia_locid="359"><systemoutput ixia_locid="360">~(keystone_admin)$</systemoutput> <userinput ixia_locid="361">system host-unlock controller-0
</userinput></codeblock>
                            <p ixia_locid="362">Unlocking the host forces a reset of the host
                                followed by a reboot. This ensures that the host is restarted in a
                                known state.</p>
                        </stepxmp>
                    </substep>
                </substeps>
                <stepresult ixia_locid="194">
                    <p ixia_locid="196">All patches are now installed on <nameliteral ixia_locid="198">controller-0</nameliteral>. Querying the current patch
                        status displays the following information:</p>
                    <codeblock ixia_locid="200"><systemoutput ixia_locid="298">~(keystone_admin)$ </systemoutput><userinput ixia_locid="204">sudo sw-patch query-hosts</userinput>
<systemoutput ixia_locid="300">
  Hostname      IP Address    Patch Current  Reboot Required  Release  State
============  ==============  =============  ===============  =======  =====
compute-0     192.168.204.12       Yes             No          15.12   idle
controller-0  192.168.204.3        No              No          15.12   idle
controller-1  192.168.204.4        No              Yes         15.12   idle
</systemoutput></codeblock>
                </stepresult>
            </step>
            <step id="step_N10260_N1009F_N1001F_N10001" ixia_locid="142">
                <cmd ixia_locid="143">Install all pending patches on <nameliteral ixia_locid="144">controller-1</nameliteral>.</cmd>
                <info ixia_locid="145">
                    <p ixia_locid="146">Repeat the previous step targeting <nameliteral ixia_locid="147">controller-1</nameliteral>.</p>
                </info>
                <stepresult ixia_locid="148">
                    <p ixia_locid="149">All patches are now installed on <nameliteral ixia_locid="150">controller-1</nameliteral> as well. Querying the
                        current patching status displays the following information:</p>
                    <codeblock ixia_locid="151"><systemoutput ixia_locid="232">~(keystone_admin)$ </systemoutput><userinput ixia_locid="153">sudo sw-patch query-hosts</userinput>
<systemoutput ixia_locid="316">
  Hostname      IP Address    Patch Current  Reboot Required  Release  State
============  ==============  =============  ===============  =======  =====
compute-0     192.168.204.12       Yes             No          15.12   idle
controller-0  192.168.204.3        Yes             No          15.12   idle
controller-1  192.168.204.4        Yes             No          15.12   idle
</systemoutput></codeblock>
                </stepresult>
            </step>
            <step id="step_N10388_N100A4_N10023_N10001" ixia_locid="285">
                <cmd ixia_locid="293">Install any pending patches for the compute or storage
                    hosts.</cmd>
                <info ixia_locid="295">
                    <note id="note_N102DE_N102DA_N102D0_N10022_N1001F_N10001" ixia_locid="394">
                        <p ixia_locid="395">All VMs currently running on a compute host are <i ixia_locid="396">live-migrated</i> to another host. If this is not
                            possible, the lock command fails. The Patch User can determine the
                            reason for the failure and decide how to proceed. For example:</p>
                        <ul id="ul_aqy_tht_xw">
                            <li ixia_locid="397">
                                <p ixia_locid="398">There may not be enough resources for the VMs on
                                    this host to live-migrate to another host, in which case:</p>
                                <ul id="ul_ltl_xht_xw">
                                    <li ixia_locid="399">
                                        <p ixia_locid="400">you can remove any VMs on other hosts
                                            that are no longer required, or </p>
                                    </li>
                                    <li ixia_locid="401">
                                        <p ixia_locid="402">you can install more hosts.</p>
                                    </li>
                                </ul>
                            </li>
                            <li ixia_locid="403">
                                <p ixia_locid="404">There may be some VMs on the host being locked
                                    that cannot support live-migration due to their current setup,
                                    in which case you you can cold-migrate such VMs</p>
                            </li>
                        </ul>
                    </note>
                    <p ixia_locid="297">If the <nameliteral ixia_locid="299">Patch
                            Current</nameliteral> status for a compute or storage host is
                            <nameliteral ixia_locid="301">No</nameliteral>, apply the pending
                        patches using the following commands:</p>
                    <codeblock ixia_locid="376"><systemoutput ixia_locid="377">~(keystone_admin)$ </systemoutput><userinput ixia_locid="378">system host-lock <varname ixia_locid="379">hostname</varname></userinput></codeblock>
                    <codeblock ixia_locid="289"><systemoutput ixia_locid="380">~(keystone_admin)$ </systemoutput><userinput ixia_locid="381">sudo sw-patch host-install-async <varname ixia_locid="382">hostname</varname></userinput></codeblock>
                    <codeblock ixia_locid="383"><systemoutput ixia_locid="384">~(keystone_admin)$ </systemoutput><userinput ixia_locid="385">system host-unlock <varname ixia_locid="386">hostname</varname></userinput></codeblock>
                    <p ixia_locid="305">where <varname ixia_locid="307">hostname</varname> is the
                        name of the host (for example, <nameliteral ixia_locid="309">compute-0</nameliteral>). </p>
                    <note id="note_N103FC_N103AC_N103A2_N1010B_N10032_N10001" ixia_locid="387">
                        <p ixia_locid="366">Patch installations can be triggered in parallel. </p>
                        <p ixia_locid="54">The <cmdname ixia_locid="367">sw-patch
                                host-install-async</cmdname> command (<uicontrol ixia_locid="56">install patches</uicontrol> on the Web administration interface)
                            can be run on all locked nodes, without waiting for one node to complete
                            the install before triggering the install on the next. If you can lock
                            the nodes at the same time, you can patch them at the same time. For
                            maximum efficiency, you can migrate VMs to lock as many compute nodes at
                            the same time as resources allow and patch at once, thereby reducing the
                            overall time required to install a patch through the whole system. </p>
                        <p ixia_locid="57">Likewise, you can install a patch to the standby
                            controller and a compute node at the same time. The only restrictions
                            are those of the lock: You cannot lock both controllers, and you cannot
                            lock a compute node if you do not have enough free resources to migrate
                            the VMs off it. Also, in a CEPH configuration (with storage nodes), you
                            cannot lock more than one of controller-0/controller-1/storage-0 at the
                            same time, as these nodes are running CEPH monitors and you must have at
                            least two in service at all times.</p>
                    </note>
                </info>
            </step>
            <step id="step_N103BC_N100A4_N10023_N10001" ixia_locid="311">
                <cmd ixia_locid="313">Confirm that all patches are installed and the Titanium Server
                    cluster is up-to-date.</cmd>
                <info ixia_locid="315">
                    <p ixia_locid="238">Use the <cmdname ixia_locid="287">sw-patch query</cmdname>
                        command to verify that all patches are <nameliteral ixia_locid="317">Applied</nameliteral>.</p>
                    <codeblock ixia_locid="235"><systemoutput ixia_locid="101">~(keystone_admin)$ </systemoutput><userinput ixia_locid="237">sudo sw-patch query</userinput>
<systemoutput ixia_locid="102">﻿       Patch ID             Patch State
=========================   ===========
TITANIUM_15.12_PATCH_0001   Applied</systemoutput></codeblock>
                    <p ixia_locid="239">If the <nameliteral ixia_locid="240">Patch
                            State</nameliteral> for any patch is still shown as <nameliteral ixia_locid="241">Available</nameliteral> or <nameliteral ixia_locid="242">Partial-Apply</nameliteral>, use the <nameliteral ixia_locid="243">sw-patch query-hosts</nameliteral> command to identify
                        which hosts are not <nameliteral ixia_locid="244">Patch
                            Current</nameliteral>, and then apply patches to them as described in
                        the preceding steps.</p>
                </info>
            </step>
        </steps>
        <result id="result_N1028F_N1001F_N10001" ixia_locid="155">
            <p ixia_locid="156">The Titanium cluster is up to date now. All patches are
                installed.</p>
        </result>
    </taskbody>
</task-wr>